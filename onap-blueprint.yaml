tosca_definitions_version: cloudify_dsl_1_3

description: >
  Blueprint deploys all ONAP kubernetes resources defined in YAML files on existing kubernetes cluster
  The following pre-setup steps are assumed, but not required:
  - Create Cloudify Example Environment: https://github.com/cloudify-examples/cloudify-environment-setup.
  - Create Kubernetes Cluster: https://github.com/cloudify-examples/simple-kubernetes-blueprint.

imports:
  - https://raw.githubusercontent.com/cloudify-cosmo/cloudify-manager/4.1/resources/rest-service/cloudify/types/types.yaml
  # Plugin required: https://github.com/cloudify-incubator/cloudify-kubernetes-plugin/releases/download/1.2.1rc1/cloudify_kubernetes_plugin-1.2.1rc1-py27-none-linux_x86_64-centos-Core.wgn
  - https://raw.githubusercontent.com/cloudify-incubator/cloudify-kubernetes-plugin/1.2.1rc1/plugin.yaml
  # Plugin required: http://repository.cloudifysource.org/cloudify/wagons/cloudify-fabric-plugin/1.4.2/cloudify_fabric_plugin-1.4.2-py27-none-linux_x86_64-centos-Core.wgn
  - http://www.getcloudify.org/spec/fabric-plugin/1.4.2/plugin.yaml
  - cloudify/types/onap.yaml

inputs:
  kubernetes_configuration_file_content:
    description: >
      File content of kubernetes master YAML configuration

  namespace_prefix:
    type: string
    description: >
      Kubernetes namespace name prefix which will be uese for all ONAP apps
    default: onap

dsl_definitions:
  options: &app_options
    namespace:
      concat: [{ get_input: namespace_prefix }, '-', { get_property: [SELF, name] }]

node_templates:
  kubernetes_master:
    type: cloudify.kubernetes.nodes.Master
    properties:
      configuration:
        file_content: { get_input: kubernetes_configuration_file_content }

  onap_environment:
    type: cloudify.onap.kubernetes.Environment
    properties:
      namespace: { get_input: namespace_prefix }
      init_pod: kubernetes/config/pod-config-init.yaml
      options:
        namespace: { get_input: namespace_prefix }
    relationships:
      - type: cloudify.kubernetes.relationships.managed_by_master
        target: kubernetes_master

  mso_app:
    type: cloudify.onap.kubernetes.App
    properties:
      name: mso
      values: kubernetes/mso/values.yaml
      resources:
        - kubernetes/mso/templates/mso-deployment.yaml
        - kubernetes/mso/templates/db-deployment.yaml
      services: kubernetes/mso/templates/all-services.yaml
      options: *app_options
    relationships:
      - type: cloudify.kubernetes.relationships.managed_by_master
        target: kubernetes_master
      - type: cloudify.relationships.depends_on
        target: onap_environment

  message_router_app:
    type: cloudify.onap.kubernetes.App
    properties:
      name: message-router
      values: kubernetes/message-router/values.yaml
      resources:
          - kubernetes/message-router/templates/message-router-zookeeper.yaml
          - kubernetes/message-router/templates/message-router-dmaap.yaml
          - kubernetes/message-router/templates/message-router-kafka.yaml
      services: kubernetes/message-router/templates/all-services.yaml
      options: *app_options
    relationships:
      - type: cloudify.kubernetes.relationships.managed_by_master
        target: kubernetes_master
      - type: cloudify.relationships.depends_on
        target: onap_environment

  sdc_app:
    type: cloudify.onap.kubernetes.App
    properties:
      name: sdc
      values: kubernetes/sdc/values.yaml
      resources:
        - kubernetes/sdc/templates/sdc-es.yaml
        - kubernetes/sdc/templates/sdc-fe.yaml
        - kubernetes/sdc/templates/sdc-kb.yaml
        - kubernetes/sdc/templates/sdc-cs.yaml
        - kubernetes/sdc/templates/sdc-be.yaml
      services: kubernetes/sdc/templates/all-services.yaml
      options: *app_options
    relationships:
      - type: cloudify.kubernetes.relationships.managed_by_master
        target: kubernetes_master
      - type: cloudify.relationships.depends_on
        target: onap_environment

  aai_app:
    type: cloudify.onap.kubernetes.App
    properties:
      name: aai
      values: kubernetes/aai/values.yaml
      resources:
        - kubernetes/aai/templates/aai-deployment.yaml
        - kubernetes/aai/templates/modelloader-deployment.yaml
        - kubernetes/aai/templates/hbase-deployment.yaml
      services: kubernetes/aai/templates/all-services.yaml
      options: *app_options
    relationships:
      - type: cloudify.kubernetes.relationships.managed_by_master
        target: kubernetes_master
      - type: cloudify.relationships.depends_on
        target: onap_environment

  robot_app:
    type: cloudify.onap.kubernetes.App
    properties:
      name: robot
      values: kubernetes/robot/values.yaml
      resources:
        - kubernetes/robot/templates/robot-deployment.yaml
      services: kubernetes/robot/templates/all-services.yaml
      options: *app_options
    relationships:
      - type: cloudify.kubernetes.relationships.managed_by_master
        target: kubernetes_master
      - type: cloudify.relationships.depends_on
        target: onap_environment

  vid_app:
    type: cloudify.onap.kubernetes.App
    properties:
      name: vid
      values: kubernetes/vid/values.yaml
      resources:
        - kubernetes/templates/vid-mariadb-deployment.yaml
        - kubernetes/templates/vid-server-deployment.yaml
      services: kubernetes/vid/templates/all-services.yaml
      options: *app_options
    relationships:
      - type: cloudify.kubernetes.relationships.managed_by_master
        target: kubernetes_master
      - type: cloudify.relationships.depends_on
        target: onap_environment

  sdnc_app:
    type: cloudify.onap.kubernetes.App
    properties:
      name: sdnc
      values: kubernetes/sdnc/values.yaml
      resources:
        - kubernetes/sdnc/templates/web-deployment.yaml
        - kubernetes/sdnc/templates/sdnc-deployment.yaml
        - kubernetes/sdnc/templates/dgbuilder-deployment.yaml
        - kubernetes/sdnc/templates/db-deployment.yaml
      services: kubernetes/sdnc/templates/all-services.yaml
      options: *app_options
    relationships:
      - type: cloudify.kubernetes.relationships.managed_by_master
        target: kubernetes_master
      - type: cloudify.relationships.depends_on
        target: onap_environment

  portal_app:
    type: cloudify.onap.kubernetes.App
    properties:
      name: portal
      values: kubernetes/portal/values.yaml
      resources:
        - kubernetes/portal/templates/portal-widgets-deployment.yaml
        - kubernetes/portal/templates/portal-apps-deployment.yaml
        - kubernetes/portal/templates/portal-mariadb-deployment.yaml
        - kubernetes/portal/templates/portal-vnc-dep.yaml
      services: kubernetes/portal/templates/all-services.yaml
      options: *app_options
    relationships:
      - type: cloudify.kubernetes.relationships.managed_by_master
        target: kubernetes_master
      - type: cloudify.relationships.depends_on
        target: onap_environment

  policy_app:
    type: cloudify.onap.kubernetes.App
    properties:
      name: policy
      values: kubernetes/policy/values.yaml
      resources:
        - kubernetes/policy/templates/dep-drools.yaml
        - kubernetes/policy/templates/dep-nexus.yaml
        - kubernetes/policy/templates/dep-brmsgw.yaml
        - kubernetes/policy/templates/dep-pdp.yaml
        - kubernetes/policy/templates/dep-pap.yaml
        - kubernetes/policy/templates/dep-maria.yaml
        - kubernetes/policy/templates/dep-pypdp.yaml
      services: kubernetes/policy/templates/all-services.yaml
      options: *app_options
    relationships:
      - type: cloudify.kubernetes.relationships.managed_by_master
        target: kubernetes_master
      - type: cloudify.relationships.depends_on
        target: onap_environment

  appc_app:
    type: cloudify.onap.kubernetes.App
    properties:
      name: appc
      values: kubernetes/appc/values.yaml
      resources:
        - kubernetes/appc/templates/appc-deployment.yaml
        - kubernetes/appc/templates/dgbuilder-deployment.yaml
        - kubernetes/appc/templates/db-deployment.yaml
      services: kubernetes/appc/templates/all-services.yaml
      options: *app_options
    relationships:
      - type: cloudify.kubernetes.relationships.managed_by_master
        target: kubernetes_master
      - type: cloudify.relationships.depends_on
        target: onap_environment
